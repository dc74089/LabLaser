{% extends 'app/base.html' %}

{% block head %}
  <style>
      #svg_contianer {
          display: flex;
          justify-content: center;
      }
  </style>

  <script>
      function rerender() {
          let data = $('.customization').map(function () {
              return $(this).val();
          }).get();

          console.log(data);

          $.get("{% url 'render' template.id %}", {data: data}, function (data) {
              $('#svg_contianer').html(data);
          })
      }

      $(document).ready(function () {
              $('.customization').on('change', rerender)
              rerender()
          }
      )

      // --- Configuration ---
      const apiKey = "{{ request.session.pat }}";
      const baseUrl = `http://{{ request.session.ip }}:2402/api/v1`;

      /**
       * Grabs the SVG from the DOM and sends it to Ruby
       */
      function sendDomSvgToLaser() {
          // 1. Get the SVG element from your container
          const svgElement = $('#svg-container').children('svg')[0];

          if (!svgElement) {
              console.error("‚ùå No SVG found inside #svg-container");
              return;
          }

          // 2. Convert the DOM element to an XML string
          const serializer = new XMLSerializer();
          const svgString = serializer.serializeToString(svgElement);

          // 3. Create a Blob (the "file" data) and a File object
          // We name it 'web_export.svg' so Ruby identifies the type correctly
          const svgBlob = new Blob([svgString], {type: 'image/svg+xml'});
          const fileObject = new File([svgBlob], "web_export.svg", {type: 'image/svg+xml'});

          console.log("üöÄ SVG captured from DOM. Uploading...");

          // 4. Proceed with the Upload
          const formData = new FormData();
          formData.append("file", fileObject);

          $.ajax({
              url: `${baseUrl}/imports`,
              type: "POST",
              headers: {
                  "Authorization": `Bearer ${apiKey}`,
                  "Accept": "application/json"
              },
              data: formData,
              processData: false,
              contentType: false,
              success: function (response) {
                  const jobId = response.id;
                  console.log(`‚úÖ Job Created! ID: ${jobId}`);

                  // Step 5: Push to Production Queue
                  setTimeout(() => pushToProduction(jobId), 1000);
              },
              error: function (xhr) {
                  console.error("‚ùå Upload failed:", xhr.responseText);
              }
          });
      }

      function pushToProduction(jobId) {
          $.ajax({
              url: `${baseUrl}/jobs/${jobId}/produce`,
              type: "PUT",
              headers: {
                  "Authorization": `Bearer ${apiKey}`,
                  "Accept": "application/json"
              },
              success: function () {
                  console.log("‚ú® Success! The job is now on the laser. Just press START.");
              },
              error: function (xhr) {
                  console.error("‚ùå Failed to push to laser:", xhr.responseText);
              }
          });
      }
  </script>
{% endblock %}

{% block content %}
  <div class="row">
    <div class="col-12 col-md-6">
      <div class="card">
        <div class="card-body">
          <div id="svg_contianer">
          </div>
        </div>
      </div>
    </div>

    <div class="col-12 col-md-6">
      <div class="card">
        <div class="card-body">
          <h2 class="text-center">Customize {{ template.name }}</h2>

          {% for i in template.slot_iterator %}
            <hr/>
            <div class="mb-3">
              <h6><label for="slot-{{ forloop.counter }}">Line {{ forloop.counter }}</label></h6>
              <input
                      type="text"
                      class="form-control customization"
                      name="slot-{{ forloop.counter }}"
                      id="slot-{{ forloop.counter }}"
                      value="Line {{ forloop.counter }}"
              >
            </div>
          {% endfor %}

          <div class="mt-4 mb-2 text-center">
            <button class="btn btn-primary btn-block" onclick="sendDomSvgToLaser()">Finished Customizing</button>
          </div>
        </div>
      </div>
    </div>
  </div>
{% endblock %}