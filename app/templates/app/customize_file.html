{% extends 'app/base.html' %}

{% block head %}
  <style>
      #svg_container {
          display: flex;
          justify-content: center;
      }
  </style>

  <script>
      function rerender() {
          let data = $('.customization').map(function () {
              return $(this).val();
          }).get();

          console.log(data);

          $.get("{% url 'render' template.id %}", {data: data}, function (data) {
              $('#svg_container').html(data);
          })
      }

      $(document).ready(function () {
              $('.customization').on('change', rerender)
              rerender()
          }
      )

      /**
       * Save the customized file to the database
       */
      function saveCustomizedFile() {
          // Get the customization data
          let data = $('.customization').map(function () {
              return $(this).val();
          }).get();

          const guestName = $('#guest_name').val() || 'Guest';

          // Prepare form data
          const formData = new FormData();
          formData.append('guest_name', guestName);
          data.forEach(item => formData.append('data[]', item));

          // Get CSRF token
          const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

          // Save to database
          $.ajax({
              url: "{% url 'save_customized_file' template.id %}",
              type: "POST",
              headers: {
                  "X-CSRFToken": csrftoken
              },
              data: formData,
              processData: false,
              contentType: false,
              success: function (response) {
                  console.log("✅ File saved successfully!");
                  // Redirect to the list page
                  window.location.href = "{% url 'list_customized_files' %}";
              },
              error: function (xhr) {
                  console.error("❌ Save failed:", xhr.responseText);
                  alert("Failed to save file. Please try again.");
              }
          });
      }
  </script>
{% endblock %}

{% block content %}
  <div class="row">
    <div class="col-12 col-md-6">
      <div class="card">
        <div class="card-body">
          <div id="svg_container">
          </div>
        </div>
      </div>
    </div>

    <div class="col-12 col-md-6">
      <div class="card">
        <div class="card-body">
          <h2 class="text-center">Customize {{ template.name }}</h2>

          {% csrf_token %}

          <div class="mb-3">
            <label for="guest_name">Guest Name (Optional)</label>
            <input
                    type="text"
                    class="form-control"
                    name="guest_name"
                    id="guest_name"
                    placeholder="Enter guest name"
            >
          </div>

          {% for i in template.slot_iterator %}
            <hr/>
            <div class="mb-3">
              <h6><label for="slot-{{ forloop.counter }}">Line {{ forloop.counter }}</label></h6>
              <input
                      type="text"
                      class="form-control customization"
                      name="slot-{{ forloop.counter }}"
                      id="slot-{{ forloop.counter }}"
                      value="Line {{ forloop.counter }}"
              >
            </div>
          {% endfor %}

          <div class="mt-4 mb-2 text-center">
            <button class="btn btn-primary btn-block" onclick="saveCustomizedFile()">Finished Customizing</button>
          </div>
        </div>
      </div>
    </div>
  </div>
{% endblock %}